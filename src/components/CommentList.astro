---
import type { CollectionEntry } from "astro:content"
import { db, and, eq, Comment } from "astro:db"

export const prerender = false

type Props = {
	post: CollectionEntry<"blogs">
}

const { post } = Astro.props

const comments = await db
	.select()
	.from(Comment)
	.where(eq(Comment.postSlug, post.slug))
	// .where(and(eq(Comment.status, "approved"), eq(Comment.postSlug, post.slug)))
	.orderBy(Comment.createdAt)
---

{
	(!comments || (comments && comments.length === 0)) && (
		<div class="my-4">No comments yet. You could be the first person to comment!</div>
	)
}
{
	comments && comments.length > 0 && (
		<>
			<ul class="my-4 space-y-4">
				{comments &&
					comments.length > 0 &&
					comments.map((comment) => (
						<li class="space-y-3 rounded border border-grayish-200 bg-grayish-100 p-4 text-grayish-700 dark:border-grayish-700 dark:bg-grayish-900 dark:text-grayish-200">
							<p class="">{comment.text}</p>
							<footer class="flex gap-1.5 text-sm text-grayish-600 dark:text-grayish-300">
								<div class="">Written by {comment.name ?? "Anonymous"}</div> on
								<time class="" datetime={comment.createdAt.toISOString()}>
									{comment.createdAt.toLocaleDateString(undefined, {
										month: "short",
										day: "numeric",
										year: "numeric"
									})}
								</time>
							</footer>
						</li>
					))}
			</ul>
		</>
	)
}
